---
// src/pages/lesson.astro
import { replaceQuranTags } from "../utils/replaceQuranTags";
import Base from "../layouts/Base.astro";
import LessonPage from "../components/LessonPage";
import BlogLessonPage from "../components/blog";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import { getCollection } from "astro:content";

export const prerender = false;

// Читаем query-параметры
const url = Astro.url;
const subject = url.searchParams.get("subject") ?? "";
const course = url.searchParams.get("course") ?? "";
const slugParam = url.searchParams.get("slug") ?? "";

if (!subject || !course) {
  throw new Error("Не переданы обязательные параметры: subject и course");
}

// ---------- 1) Предмет ----------
const subjects = await getCollection("subjects");
const subjectEntry = subjects.find((s) => s.data.slug === subject);

if (!subjectEntry) {
  throw new Error(`Предмет не найден: ${subject}`);
}

// ---------- 2) Курс ----------
const courses = await getCollection("courses");
const courseEntry = courses.find(
  (c) => c.data.subject === subject && c.data.slug === course
);

if (!courseEntry) {
  throw new Error(`Курс не найден: ${subject}/${course}`);
}

const courseTitle = courseEntry.data.title;
const layoutMode = courseEntry.data.layout ?? "tabs"; // "blog" → BlogLessonPage, иначе → LessonPage

// ---------- 3) Уроки курса ----------
const lessonsCollection = await getCollection("lessons", ({ data }) =>
  data.subject === subject && data.course === course
);

const sortedLessons = lessonsCollection
  .slice()
  .sort((a, b) => (a.data.order ?? 999) - (b.data.order ?? 999));

const hasLessons = sortedLessons.length > 0;
const emptyStateMessage = "Для выбранного курса уроки ещё не загружены";

let currentLesson: any = null;
let lessons: any[] = [];

if (hasLessons) {
  // slugParam может быть либо "predislovie", либо полный slug вроде "akida/uchebnik-6-stolpov/predislovie"
  const normalizeSlug = (s: string) => s.replace(/^\//, "");

  const target = sortedLessons.find((l) => {
    const full = normalizeSlug(l.slug);
    const justLast = full.split("/").pop();
    return (
      full === normalizeSlug(slugParam) || justLast === normalizeSlug(slugParam)
    );
  }) ?? sortedLessons[0];

  // Рендерим контент текущего урока
  const { Content } = await target.render();
  const rawHtml = await Content();
  const html = replaceQuranTags(rawHtml);

  // Аудио / видео
  const audioUrl = target.data.audioRel
    ? `/media/${subject}/${course}/${target.data.audioRel}`
    : target.data.audio ?? null;

  const videoUrl = target.data.videoRel
    ? `/media/${subject}/${course}/${target.data.videoRel}`
    : target.data.video ?? null;

  currentLesson = {
    slug: target.slug,
    title: target.data.title,
    order: target.data.order,
    html,
    audio: audioUrl,
    video: videoUrl,
    hasAudio: Boolean(target.data.hasAudio ?? audioUrl),
    hasVideo: Boolean(target.data.hasVideo ?? videoUrl),
  };

  lessons = sortedLessons.map((l) => ({
    slug: l.slug,
    title: l.data.title,
    order: l.data.order,
    hasAudio: Boolean(l.data.hasAudio ?? l.data.audio ?? l.data.audioRel),
    hasVideo: Boolean(l.data.hasVideo ?? l.data.video ?? l.data.videoRel),
  }));
}
---

<Base title={`${subjectEntry.data.title} — ${courseTitle}`}>
  <Breadcrumbs
    items={[
      { label: "Главная", href: "/" },
      { label: subjectEntry.data.title, href: `/${subjectEntry.data.slug}/` },
      { label: courseTitle, href: `/${subject}/${course}` },
      {
        label:
          hasLessons && currentLesson
            ? currentLesson.title
            : "Урок не найден",
      },
    ]}
  />

  {
    hasLessons && currentLesson ? (
      layoutMode === "blog" ? (
        <BlogLessonPage
          client:load
          subject={subject}
          course={course}
          courseTitle={courseTitle}
          currentLesson={currentLesson}
          lessons={lessons}
        />
      ) : (
        <LessonPage
          client:load
          subject={subject}
          course={course}
          courseTitle={courseTitle}
          currentLesson={currentLesson}
          lessons={lessons}
        />
      )
    ) : (
      <section class="no-lessons-message">
        <p>{emptyStateMessage}</p>
      </section>
    )
  }
</Base>
