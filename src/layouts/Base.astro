---
import "../styles/tailwind.css";
import NavBar from "@/components/NavBar";

const { title = "Lesson" } = Astro.props as { title?: string };
---

<html lang="ru" class="bg-background text-foreground">
  <head>
    <!-- Тема из localStorage -->
    <script is:inline>
      (function () {
        try {
          var ls = localStorage.getItem('theme');
          var m = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          var dark = ls ? ls === 'dark' : m;
          if (dark) document.documentElement.classList.add('dark');
          document.documentElement.style.colorScheme = dark ? 'dark' : 'light';
        } catch (e) {}
      })();
    </script>

    <!-- Quran audio: плейлисты + кастомная кнопка play/pause -->
    <script is:inline>
      (function () {
        if (typeof window === 'undefined') return;

        // --- Плейлисты (для диапазонов аятов) ---
        function parsePlaylist(raw) {
          if (!raw) return [];
          try {
            var parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              return parsed.filter(function (item) {
                return typeof item === 'string' && item.trim().length > 0;
              });
            }
          } catch (err) {
            // ignore, fallback below
          }
          return raw
            .split('|')
            .map(function (s) { return s.trim(); })
            .filter(function (s) { return s.length > 0; });
        }

        function enhanceAudio(audio) {
          var tracks = parsePlaylist(audio.getAttribute('data-playlist') || '');
          if (!tracks.length) return;

          var index = 0;

          function setTrack(nextIndex, autoplay) {
            index = nextIndex;
            audio.src = tracks[index];
            audio.currentTime = 0;
            audio.load();
            if (autoplay) {
              var playPromise = audio.play();
              if (playPromise && typeof playPromise.catch === 'function') {
                playPromise.catch(function () {});
              }
            }
          }

          setTrack(0, false);

          audio.addEventListener('ended', function () {
            if (index < tracks.length - 1) {
              // продолжаем следующий аят
              setTrack(index + 1, true);
            } else {
              // плейлист закончился — сбрасываемся в начало и шлём кастомное событие
              setTrack(0, false);

              var ev;
              try {
                ev = new CustomEvent('quran-playlist-finished');
              } catch (e) {
                ev = document.createEvent('CustomEvent');
                ev.initCustomEvent('quran-playlist-finished', false, false, {});
              }
              audio.dispatchEvent(ev);
            }
          });
        }

        // --- Кастомная кнопка "квадрат с треугольником" для аятов ---
        var currentQuranAudio = null;
        var currentQuranButton = null;

        function setupQuranAudioButtons() {
          var blocks = document.querySelectorAll('.quran-ayah-block');
          blocks.forEach(function (block) {
            var button = block.querySelector('.quran-audio-button');
            var audio = block.querySelector('audio.quran-audio-element');
            if (!button || !audio) return;

            if (button.getAttribute('data-quran-audio-initialized') === 'true') {
              return;
            }
            button.setAttribute('data-quran-audio-initialized', 'true');

            // Клик по плашке: play/pause
            button.addEventListener('click', function () {
              // если уже играет другой аят — останавливаем его
              if (currentQuranAudio && currentQuranAudio !== audio) {
                currentQuranAudio.pause();
                currentQuranAudio.currentTime = 0;
                if (currentQuranButton) {
                  currentQuranButton.removeAttribute('data-state');
                }
                currentQuranAudio = null;
                currentQuranButton = null;
              }

              if (audio.paused) {
                var playPromise = audio.play();
                currentQuranAudio = audio;
                currentQuranButton = button;
                button.setAttribute('data-state', 'playing');
                if (playPromise && typeof playPromise.catch === 'function') {
                  playPromise.catch(function () {});
                }
              } else {
                audio.pause();
                button.removeAttribute('data-state');
                currentQuranAudio = null;
                currentQuranButton = null;
              }
            });

            // Для одиночных аятов (без плейлиста) — по окончании сбрасываем кнопку
            if (!audio.hasAttribute('data-playlist')) {
              audio.addEventListener('ended', function () {
                if (currentQuranAudio === audio) {
                  currentQuranAudio = null;
                  if (currentQuranButton) {
                    currentQuranButton.removeAttribute('data-state');
                    currentQuranButton = null;
                  }
                }
              });
            }

            // Для диапазонов: плейлист отработал до конца -> сбросить кнопку
            audio.addEventListener('quran-playlist-finished', function () {
              if (currentQuranAudio === audio) {
                currentQuranAudio = null;
                if (currentQuranButton) {
                  currentQuranButton.removeAttribute('data-state');
                  currentQuranButton = null;
                }
              }
            });
          });
        }

        // --- Инициализация всего, что связано с Quran-аудио ---
        function initAll() {
          // Подготовить плейлисты (audio[data-playlist])
          document.querySelectorAll('audio[data-playlist]').forEach(function (audio) {
            if (audio.getAttribute('data-playlist-initialized') === 'true') {
              return;
            }
            audio.setAttribute('data-playlist-initialized', 'true');
            enhanceAudio(audio);
          });

          // Настроить кастомные кнопки "play/pause"
          setupQuranAudioButtons();
        }

        document.addEventListener('astro:page-load', initAll);
        document.addEventListener('quran:reinit', initAll);

        var scheduleId = null;
        var observer = new MutationObserver(function () {
          if (scheduleId !== null) return;
          scheduleId = requestAnimationFrame(function () {
            scheduleId = null;
            initAll();
          });
        });
        observer.observe(document.documentElement, { childList: true, subtree: true });

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initAll);
        } else {
          initAll();
        }
      })();
    </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
  </head>
  <body class="min-h-screen bg-background text-foreground">
    <header class="sticky top-0 z-40 border-b bg-background/80 dark:bg-[#181818] backdrop-blur supports-[backdrop-filter]:bg-background/60 supports-[backdrop-filter]:dark:bg-[#181818]/95">
      <NavBar client:load currentPath={Astro.url.pathname} />
    </header>
    <main class="mx-auto max-w-7xl px-4 py-6">
      <slot />
    </main>
  </body>
</html>
